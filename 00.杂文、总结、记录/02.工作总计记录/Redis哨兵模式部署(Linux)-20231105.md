# Redis哨兵模式部署(Linux)

___

> Redis单体从压缩包解压到编译安装的过程可查看笔记：[Redis单节点部署](Redis单节点部署(Linux)-20231008.md)

## 部署模式

> 一主两从三哨兵
> > 192.168.1.11:6379 master
> >
> > 192.168.1.17:6379 slave1
> >
> > 192.168.1.17:6380 slave2
> >
> > 192.168.1.19:26379 sentinel1
> >
> > 192.168.1.19:26380 sentinel2
> >
> > 192.168.1.19:26381 sentinel3

## 主要配置

```shell
# 端口
port 26379
# 哨兵 sentinel 监控的 redis 主节点的 
# sentinel monitor <master-name> <ip> <redis-port> <quorum>
# 这个2代表，当集群中有2个sentinel认为master死了时，才能真正认为该master已经不可用了。
sentinel monitor mymaster 192.168.1.11 6379 2
# 当在Redis实例中开启了requirepass <foobared>，所有连接Redis实例的客户端都要提供密码。
sentinel auth-pass mymaster 123456
# 指定主节点应答哨兵sentinel的最大时间间隔，超过这个时间，哨兵主观上认为主节点下线，默认30秒 
# Default is 30 seconds.
sentinel down-after-milliseconds mymaster 30000
# 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为1，来保证每次只有一个slave，处于不能处理命令请求的状态。
# 故障转移时最多可以有1个从节点同时对主节点进行数据同步,数字越大,用时越短,存在网络和IO开销
# sentinel parallel-syncs <master-name> <numslaves>
sentinel parallel-syncs mymaster 1
# 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面：
## 1. 同一个sentinel对同一个master两次failover之间的间隔时间。  
## 2. 当一个slave从一个错误的master那里同步数据时开始，直到slave被纠正为从正确的master那里同步数据时结束。  
## 3. 当想要取消一个正在进行的failover时所需要的时间。
## 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来同步数据了
# sentinel failover-timeout <master-name> <milliseconds>  
sentinel failover-timeout mymaster 180000
# 开启自动修改配置
sentinel deny-scripts-reconfig yes
```

## 启动

### 编写启动脚本

```shell
echo "Start sentinel-26379"
redis-sentinel /redis/redis-sentinel-26379/bin/sentinel.conf &
echo "Start sentinel-26380"
redis-sentinel /redis/redis-sentinel-26380/bin/sentinel.conf &
echo "Start sentinel-26381"
redis-sentinel /redis/redis-sentinel-26381/bin/sentinel.conf &
```

### 执行启动脚本

```shell
sh redis-sentinel.sh
```

执行脚本没有出现报错

观察sentinel启动日志，没有报错，并且记录有redis主从节点的信息，后续加进的sentinel节点信息也有相关记录

```shell
22121:X 05 Nov 2023 21:32:34.976 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
22121:X 05 Nov 2023 21:32:34.976 # Redis version=7.0.11, bits=64, commit=00000000, modified=0, pid=22121, just started
22121:X 05 Nov 2023 21:32:34.976 # Configuration loaded
22121:X 05 Nov 2023 21:32:34.976 * Increased maximum number of open files to 10032 (it was originally set to 1024).
22121:X 05 Nov 2023 21:32:34.976 * monotonic clock: POSIX clock_gettime
22121:X 05 Nov 2023 21:32:34.977 * Running mode=sentinel, port=26379.
22121:X 05 Nov 2023 21:32:34.977 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
22121:X 05 Nov 2023 21:32:34.981 * Sentinel new configuration saved on disk
22121:X 05 Nov 2023 21:32:34.981 # Sentinel ID is 812f1cac69a7e4915dc83b89a06ac65652a9cace
22121:X 05 Nov 2023 21:32:34.981 # +monitor master mymaster 192.168.1.11 6379 quorum 2
22121:X 05 Nov 2023 21:32:34.982 * +slave slave 192.168.1.17:6379 192.168.1.17 6379 @ mymaster 192.168.1.11 6379
22121:X 05 Nov 2023 21:32:34.984 * Sentinel new configuration saved on disk
22121:X 05 Nov 2023 21:32:34.984 * +slave slave 192.168.1.17:6380 192.168.1.17 6380 @ mymaster 192.168.1.11 6379
22121:X 05 Nov 2023 21:32:34.986 * Sentinel new configuration saved on disk
22121:X 05 Nov 2023 21:32:36.986 * +sentinel sentinel 72f98d3d7b417cc978346259d421c4189bd910e5 192.168.1.19 26380 @ mymaster 192.168.1.11 6379
22121:X 05 Nov 2023 21:32:36.989 * Sentinel new configuration saved on disk
22121:X 05 Nov 2023 21:32:36.991 * +sentinel sentinel 19963b0b606bad307053ad804484bc1ac5004e5e 192.168.1.19 26381 @ mymaster 192.168.1.11 6379
22121:X 05 Nov 2023 21:32:36.993 * Sentinel new configuration saved on disk
22121:X 05 Nov 2023 21:33:04.991 # +sdown slave 192.168.1.17:6380 192.168.1.17 6380 @ mymaster 192.168.1.11 6379
```

### 观察变化

配置文件项`sentinel.conf`出现变化

其中一个示例，有发现redis从节点及sentinel其它节点的信息

```shell
# Generated by CONFIG REWRITE

latency-tracking-info-percentiles 50 99 99.9
user default on nopass ~* &* +@all
sentinel myid 812f1cac69a7e4915dc83b89a06ac65652a9cace
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
sentinel current-epoch 0

sentinel known-replica mymaster 192.168.1.17 6380

sentinel known-replica mymaster 192.168.1.17 6379

sentinel known-sentinel mymaster 192.168.1.19 26381 19963b0b606bad307053ad804484bc1ac5004e5e

sentinel known-sentinel mymaster 192.168.1.19 26380 72f98d3d7b417cc978346259d421c4189bd910e5
```

登录随意一个sentinel节点

```shell
192.168.1.19:26380> info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=192.168.1.11:6379,slaves=2,sentinels=3
```

redis master地址，从库数量，哨兵数量正确，状态ok

## 测试哨兵模式

关闭redis master节点

```shell
192.168.1.11:6379> shutdown
(0.80s)
```

观察sentinel变化

```shell
192.168.1.19:26380> info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=192.168.1.17:6379,slaves=2,sentinels=3
```

已经进行切换